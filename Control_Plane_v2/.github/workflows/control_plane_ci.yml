name: Control Plane CI

on:
  push:
    branches: [main, release/*]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.12'

jobs:
  validate:
    name: Validate Control Plane
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          # Install any required packages (none currently)

      - name: Validate packages registry
        run: python3 scripts/validate_packages.py

      - name: Sync packages
        run: python3 scripts/package_sync.py

      - name: Integrity check
        run: python3 scripts/integrity_check.py --verify --orphans --chain

      - name: Pristine boundary tests
        run: python3 tests/test_pristine.py

      - name: Provenance tests
        run: python3 tests/test_provenance.py

  seal-check:
    name: Seal Enforcement
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Enforce signatures + attestations (strict)
        env:
          CONTROL_PLANE_ALLOW_UNSIGNED: "0"
          CONTROL_PLANE_ALLOW_UNATTESTED: "0"
        run: |
          python3 -c "
          import csv
          from pathlib import Path

          reg = Path('registries/packages_registry.csv')
          if not reg.exists():
              print('WARN: packages_registry.csv not found')
              exit(0)

          errors = []
          with reg.open() as f:
              reader = csv.DictReader(f)
              for row in reader:
                  status = (row.get('status') or '').strip()
                  source_type = (row.get('source_type') or '').strip()

                  # Only check active tar packages
                  if status != 'active' or source_type != 'tar':
                      continue

                  pkg_id = row.get('id', 'UNKNOWN')

                  # Check signature
                  signature = (row.get('signature') or '').strip()
                  if not signature:
                      errors.append(f'{pkg_id}: missing signature')

                  # Check attestation
                  attestation_path = (row.get('attestation_path') or '').strip()
                  if not attestation_path:
                      errors.append(f'{pkg_id}: missing attestation')

          if errors:
              print('SEAL CHECK FAILED:')
              for e in errors:
                  print(f'  FAIL: {e}')
              exit(1)

          print('OK: All active packages signed and attested')
          "

      - name: Verify ledger chain integrity
        run: |
          python3 -c "
          import sys
          sys.path.insert(0, '.')

          from lib.ledger_client import LedgerClient

          try:
              client = LedgerClient()
              valid, issues = client.verify_chain()

              if issues:
                  print('Ledger verification issues:')
                  for issue in issues:
                      print(f'  {issue}')

              if not valid:
                  print('FAIL: Ledger chain integrity check failed')
                  exit(1)

              print('OK: Ledger chain intact')
          except Exception as e:
              print(f'WARN: Could not verify ledger: {e}')
              # Don't fail if ledger doesn't exist yet
              exit(0)
          "

  # Optional: Run on release tags for stricter verification
  release-check:
    name: Release Verification
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Full integrity verification
        run: |
          python3 scripts/integrity_check.py --verify --orphans --chain --strict

      - name: Verify all packages have attestations
        run: |
          python3 -c "
          import csv
          from pathlib import Path

          reg = Path('registries/packages_registry.csv')
          if not reg.exists():
              exit(0)

          missing = []
          with reg.open() as f:
              for row in csv.DictReader(f):
                  status = (row.get('status') or '').strip()
                  if status != 'active':
                      continue

                  att_path = (row.get('attestation_path') or '').strip()
                  att_digest = (row.get('attestation_digest') or '').strip()
                  sig = (row.get('signature') or '').strip()

                  pkg_id = row.get('id', 'UNKNOWN')

                  if not att_path:
                      missing.append(f'{pkg_id}: no attestation_path')
                  if not att_digest:
                      missing.append(f'{pkg_id}: no attestation_digest')
                  if not sig:
                      missing.append(f'{pkg_id}: no signature')

          if missing:
              print('RELEASE CHECK FAILED - Missing provenance data:')
              for m in missing:
                  print(f'  {m}')
              exit(1)

          print('OK: All active packages have full provenance')
          "
