{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://controlplane.local/schemas/chat_response.json",
  "title": "Chat Response",
  "description": "Output schema for chat interface",
  "type": "object",
  "required": ["response", "session_id", "turn_number", "handler", "duration_ms"],
  "properties": {
    "response": {
      "type": "string",
      "description": "Handler result (markdown formatted)"
    },
    "session_id": {
      "type": "string",
      "description": "Session identifier",
      "pattern": "^SES-CHAT-[0-9]{8}-[a-f0-9]{8}$"
    },
    "turn_number": {
      "type": "integer",
      "description": "Turn number within session",
      "minimum": 1
    },
    "classification": {
      "type": "object",
      "description": "Query classification details",
      "properties": {
        "type": {
          "type": "string",
          "description": "Query type",
          "enum": [
            "browse_dir",
            "browse_code",
            "search_code",
            "package_list",
            "package_inspect",
            "package_preflight",
            "package_install",
            "package_uninstall",
            "package_stage",
            "ledger_query",
            "help",
            "general"
          ]
        },
        "confidence": {
          "type": "number",
          "description": "Classification confidence",
          "minimum": 0,
          "maximum": 1
        },
        "pattern_matched": {
          "type": "boolean",
          "description": "Whether a pattern was matched"
        },
        "matched_pattern": {
          "type": ["string", "null"],
          "description": "Name of matched pattern"
        },
        "extracted_args": {
          "type": "object",
          "description": "Arguments extracted from query"
        }
      }
    },
    "handler": {
      "type": "string",
      "description": "Handler that processed the query"
    },
    "duration_ms": {
      "type": "integer",
      "description": "Processing time in milliseconds",
      "minimum": 0
    },
    "error": {
      "type": "string",
      "description": "Error message if request failed"
    }
  },
  "examples": [
    {
      "response": "# Contents of `modules/`\n\n**Directories:**\n- admin_agent/\n- chat_interface/\n...",
      "session_id": "SES-CHAT-20260204-abc12345",
      "turn_number": 1,
      "classification": {
        "type": "browse_dir",
        "confidence": 1.0,
        "pattern_matched": true,
        "matched_pattern": "whats in dir",
        "extracted_args": {
          "dir_path": "modules"
        }
      },
      "handler": "browse_dir",
      "duration_ms": 12
    }
  ]
}
