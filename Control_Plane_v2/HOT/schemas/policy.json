{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://control-plane.local/schemas/policy.json",
  "title": "Policy Document Schema v1.0",
  "description": "Schema for policy documents - declarative rules for installation, attention, and governance",
  "type": "object",
  "required": [
    "schema_version",
    "policy_id",
    "policy_type",
    "version",
    "effective_date",
    "rules"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0",
      "description": "Policy schema version"
    },
    "policy_id": {
      "type": "string",
      "pattern": "^POL-[A-Z0-9-]+$",
      "description": "Unique policy identifier"
    },
    "policy_type": {
      "type": "string",
      "enum": ["install", "attention", "access", "audit", "governance"],
      "description": "Type of policy"
    },
    "name": {
      "type": "string",
      "maxLength": 100,
      "description": "Human-readable policy name"
    },
    "description": {
      "type": "string",
      "maxLength": 500,
      "description": "Policy description"
    },
    "version": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$",
      "description": "Semantic version"
    },
    "effective_date": {
      "type": "string",
      "format": "date-time",
      "description": "When this policy becomes active"
    },
    "expiry_date": {
      "type": "string",
      "format": "date-time",
      "description": "Optional expiration date"
    },
    "applies_to": {
      "type": "object",
      "description": "Scope of policy application",
      "properties": {
        "planes": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["hot", "first", "second", "all"]
          },
          "description": "Planes this policy applies to"
        },
        "tiers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["G0", "T0", "T1", "T2", "T3", "all"]
          },
          "description": "Package tiers this policy applies to"
        },
        "environments": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["dev", "staging", "prod", "all"]
          },
          "description": "Environments this policy applies to"
        },
        "package_patterns": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Package ID patterns (glob) this policy applies to"
        }
      }
    },
    "rules": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/rule"
      },
      "minItems": 1,
      "description": "Policy rules"
    },
    "exceptions": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/exception"
      },
      "description": "Policy exceptions"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "author": {
          "type": "string"
        },
        "approver": {
          "type": "string"
        },
        "approved_at": {
          "type": "string",
          "format": "date-time"
        },
        "review_date": {
          "type": "string",
          "format": "date"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  },
  "$defs": {
    "rule": {
      "type": "object",
      "required": ["rule_id", "condition", "effect"],
      "properties": {
        "rule_id": {
          "type": "string",
          "pattern": "^R[0-9]{3}$",
          "description": "Rule identifier within policy"
        },
        "description": {
          "type": "string",
          "maxLength": 200
        },
        "condition": {
          "type": "object",
          "description": "Condition that triggers the rule",
          "properties": {
            "action": {
              "type": "string",
              "enum": ["install", "uninstall", "update", "verify", "pack", "sign", "*"]
            },
            "tier": {
              "type": "string",
              "enum": ["G0", "T0", "T1", "T2", "T3", "*"]
            },
            "plane": {
              "type": "string",
              "enum": ["hot", "first", "second", "*"]
            },
            "environment": {
              "type": "string",
              "enum": ["dev", "staging", "prod", "*"]
            },
            "has_attestation": {
              "type": "boolean"
            },
            "has_signature": {
              "type": "boolean"
            },
            "custom": {
              "type": "object",
              "additionalProperties": true,
              "description": "Custom condition fields"
            }
          }
        },
        "effect": {
          "type": "string",
          "enum": ["allow", "deny", "require_approval", "audit", "warn"],
          "description": "Effect when condition matches"
        },
        "requirements": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "signature",
              "attestation",
              "approval",
              "audit_log",
              "integrity_check",
              "tier_validation"
            ]
          },
          "description": "Additional requirements when rule matches"
        },
        "priority": {
          "type": "integer",
          "minimum": 0,
          "maximum": 1000,
          "default": 100,
          "description": "Rule priority (higher = evaluated first)"
        }
      }
    },
    "exception": {
      "type": "object",
      "required": ["exception_id", "rule_ids", "reason"],
      "properties": {
        "exception_id": {
          "type": "string",
          "pattern": "^EX[0-9]{3}$"
        },
        "rule_ids": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^R[0-9]{3}$"
          },
          "description": "Rules this exception applies to"
        },
        "reason": {
          "type": "string",
          "maxLength": 500
        },
        "approved_by": {
          "type": "string"
        },
        "expires_at": {
          "type": "string",
          "format": "date-time"
        },
        "scope": {
          "type": "object",
          "properties": {
            "packages": {
              "type": "array",
              "items": { "type": "string" }
            },
            "subjects": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        }
      }
    }
  }
}
